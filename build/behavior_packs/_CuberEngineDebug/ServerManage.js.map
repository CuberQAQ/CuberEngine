{"version":3,"sources":["ServerManage.ts"],"names":[],"mappings":"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","file":"../CuberEngine/scripts/ServerManage.js","sourcesContent":["// ServerManage for Minecraft Bedrock Edition\r\n// Author: CuberQAQ <https://github.com/CuberQAQ>\r\n// Liscence: GPLv3 https://www.gnu.org/licenses/gpl-3.0.html\r\n// Based on GameTest Framework (https://learn.microsoft.com/zh-cn/minecraft/creator/scriptapi/)\r\n// Version: 3.0.0\r\n\r\n// Copyright CuberQAQ. All rights reserved.\r\nimport {\r\n  Player,\r\n  world,\r\n  DynamicPropertiesDefinition,\r\n  PropertyRegistry,\r\n  system,\r\n  BlockType,\r\n  GameMode,\r\n} from \"@minecraft/server\";\r\nimport { data, saveData } from \"./Data\";\r\nimport { addRunBeforeTp } from \"./CuberSnow\";\r\nimport { anaylseError, getGamemode, setTimeout, tellMessage } from \"./utils\";\r\nimport { MessageFormData } from \"@minecraft/server-ui\";\r\nconst moduleName = \"ServerManage\";\r\nconst moduleVersion = \"0.1.0\";\r\nconst overworld = world.getDimension(\"overworld\");\r\n\r\ninterface EntityClearConfigListType {\r\n  name: string;\r\n  types: Array<[string, boolean, string?]>;\r\n}\r\ninterface EntityClearConfigType {\r\n  name: string;\r\n  show: string;\r\n  display: boolean;\r\n  enable: boolean;\r\n  time: number;\r\n  last_clear: number;\r\n  forecasted: boolean;\r\n  forecast: boolean;\r\n  foretime: number;\r\n  list: Array<EntityClearConfigListType>;\r\n}\r\n\r\nasync function clearEntity(config: EntityClearConfigType) {\r\n  config.forecasted = false;\r\n  config.last_clear = new Date().getTime();\r\n  if (config.display) {\r\n    tellMessage(data.settings.entity_clear.sender, \"即将清理§e§l\" + config.show ?? config.name + \"§r...\");\r\n  }\r\n  // Run Clear Task\r\n  let total_clear = 0;\r\n  for (let j = 0; j < config.list.length; ++j) {\r\n    let typesLength = config.list[j].types.length;\r\n    for (let i = 0; i < typesLength; ++i) {\r\n      if (config.list[j].types[i][1]) {\r\n        try {\r\n          total_clear += (await overworld.runCommandAsync(\"kill @e[type=\" + config.list[j].types[i][0] + \"]\"))\r\n            .successCount;\r\n        } catch (e) {\r\n          if (!(typeof e == \"string\" && e.trim() == \"No targets matched selector\")) {\r\n            anaylseError(moduleName, e, \"In Entity Clear Task\");\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  tellMessage(\r\n    data.settings.entity_clear.sender,\r\n    \"\" + (config.show ?? config.name) + \"§a§l清理完成！§r本次共清理§e§l\" + total_clear + \"§r个实体\"\r\n  );\r\n  data.settings.entity_clear.total_clear += total_clear;\r\n  saveData();\r\n}\r\nfunction initServerManage() {\r\n  world.events.blockBreak.subscribe((e) => {\r\n    if (!e.player.hasTag(data.settings.new_player.limit_tag)) {\r\n      if (\r\n        e.dimension != overworld ||\r\n        e.block.x < data.settings.new_player.allow_area.begin_x ||\r\n        e.block.x > data.settings.new_player.allow_area.end_x ||\r\n        e.block.z < data.settings.new_player.allow_area.begin_z ||\r\n        e.block.z > data.settings.new_player.allow_area.end_z\r\n      ) {\r\n        // e.block.setType(e.brokenBlockPermutation.type);\r\n        e.block.setPermutation(e.brokenBlockPermutation);\r\n        e.player.runCommandAsync(\r\n          'tellraw @a {\"rawtext\":[{\"text\":\"§c不允许在新人建筑区外破坏方块 @' + e.player.name + '\"}]}'\r\n        );\r\n      }\r\n    }\r\n  });\r\n  world.events.blockPlace.subscribe((e) => {\r\n    if (!e.player.hasTag(data.settings.new_player.limit_tag)) {\r\n      if (\r\n        e.dimension != overworld ||\r\n        e.block.x < data.settings.new_player.allow_area.begin_x ||\r\n        e.block.x > data.settings.new_player.allow_area.end_x ||\r\n        e.block.z < data.settings.new_player.allow_area.begin_z ||\r\n        e.block.z > data.settings.new_player.allow_area.end_z\r\n      ) {\r\n        e.player.runCommandAsync(\"setblock \" + e.block.x + \" \" + e.block.y + \" \" + e.block.z + \" air\");\r\n        e.player.runCommandAsync(\r\n          'tellraw @a {\"rawtext\":[{\"text\":\"§c不允许在新人建筑区外放置方块 @' + e.player.name + '\"}]}'\r\n        );\r\n      }\r\n    }\r\n  });\r\n  world.events.beforeItemUse.subscribe((e) => {\r\n    if (e.source instanceof Player) {\r\n      e.source.location.x;\r\n      if (\r\n        !e.source.hasTag(data.settings.new_player.limit_tag) &&\r\n        (e.source.dimension != overworld ||\r\n          e.source.location.x < data.settings.new_player.allow_area.begin_x ||\r\n          e.source.location.x > data.settings.new_player.allow_area.end_x ||\r\n          e.source.location.z < data.settings.new_player.allow_area.begin_z ||\r\n          e.source.location.z > data.settings.new_player.allow_area.end_z)\r\n      ) {\r\n        if (e.item.typeId != \"minecraft:snowball\") {\r\n          e.cancel = true;\r\n          e.source.runCommandAsync(\r\n            'tellraw @s {\"rawtext\":[{\"text\":\"§c不允许在新人建筑区外使用工具 @' + e.source.name + '\"}]}'\r\n          );\r\n        }\r\n      }\r\n    }\r\n  });\r\n  world.events.beforeExplosion.subscribe((e) => {\r\n    if (!data.settings.world.allow_explode) {\r\n      e.source.runCommandAsync('tellraw @a {\"rawtext\":[{\"text\":\"§c不允许发生爆炸\"}]}');\r\n      e.cancel = true;\r\n    }\r\n  });\r\n  // 玩家数据初始化\r\n  world.events.playerJoin.subscribe((e) => {\r\n    if (data.players[e.player.name] == undefined) {\r\n      tellMessage(moduleName, \"初始化个人信息 §e@\" + e.player.name);\r\n      // e.player.runCommandAsync('scoreboard players add \"' + e.player.name + '\" time 0');\r\n      data.players[e.player.name] = {\r\n        job: data.settings.players.default_job,\r\n        score_id: e.player.scoreboard.id,\r\n        goodat: data.settings.players.default_goodat,\r\n        money: data.settings.players.default_money,\r\n        place: data.settings.players.default_place,\r\n        last_login: new Date().getTime(), // UTC ms\r\n        last_checkin: 0, // YYYYMMDD\r\n        checkin_times: 0,\r\n      };\r\n      e.player.runCommandAsync(\"give @s snowball 16\");\r\n      saveData();\r\n    } else {\r\n      data.players[e.player.name].last_login = new Date().getTime();\r\n      saveData();\r\n    }\r\n  });\r\n  world.events.entityHit.subscribe((e) => {\r\n    e.hitBlock?.trySetPermutation(e.hitBlock.permutation);\r\n  });\r\n  addRunBeforeTp(\"serverManage_newPlayer\", async (player, list_key) => {\r\n    if (data.settings.new_player.change_gamemode && !player.hasTag(data.settings.new_player.limit_tag)) {\r\n      if (!((await getGamemode(player)) == GameMode.spectator)) {\r\n        let msfr = await new MessageFormData()\r\n          .title(\"提示\")\r\n          .body(\"即将进入旁观者模式，聊天栏输入#exit可返回新人建筑区并退出旁观者模式\")\r\n          .button1(\"明白了\")\r\n          .button2(\"取消传送\")\r\n          .show(player);\r\n        if (msfr.selection == 1) {\r\n          player.runCommandAsync(\"gamemode spectator\");\r\n          tellMessage(\"§b§l提示\", \"§e§l\" + player.name + \"§r 正在参观地图!\");\r\n          return { cancel: false };\r\n        }\r\n        return { cancel: true, cancelReason: \"取消传送\" };\r\n      }\r\n    }\r\n    return { cancel: false };\r\n  });\r\n  world.events.beforeChat.subscribe(async (e) => {\r\n    if (e.message.trim() == \"#exit\") {\r\n      tellMessage(\"§b§l雪球菜单\", \"§e§l\" + e.sender.name + \"§r 返回了 §a§l新人建筑区\");\r\n      // tellMessage(\r\n      //   moduleName,\r\n      //   \"x:\" + (data.settings.new_player.allow_area.end_x - data.settings.new_player.allow_area.begin_x) / 2\r\n      // );\r\n      // tellMessage(\r\n      //   moduleName,\r\n      //   \"x2:\" +\r\n      //     (data.settings.new_player.allow_area.begin_x +\r\n      //       (data.settings.new_player.allow_area.end_x - data.settings.new_player.allow_area.begin_x) / 2)\r\n      // );\r\n      let cmd =\r\n        \"tp \" +\r\n        (data.settings.new_player.allow_area.begin_x +\r\n          (data.settings.new_player.allow_area.end_x - data.settings.new_player.allow_area.begin_x) / 2) +\r\n        \" 200 \" +\r\n        (data.settings.new_player.allow_area.begin_z +\r\n          (data.settings.new_player.allow_area.end_z - data.settings.new_player.allow_area.begin_z) / 2);\r\n      e.sender.runCommandAsync(cmd);\r\n      e.sender.runCommandAsync(\"gamemode 1\");\r\n\r\n      // tellMessage(moduleName, \"§e\" + e.sender.name + \"§r 返回了 §a新人建筑区2\");\r\n      // try {\r\n      //   var gamemode = await getGamemode(e.sender);\r\n      // } catch (e) {\r\n      //   anaylseError(moduleName, e, \"wtf?\");\r\n      // }\r\n      // if (gamemode != GameMode.survival && gamemode != GameMode.adventure) {\r\n      //   tellMessage(moduleName, \"§e\" + e.sender.name + \"§r 返回了 §a新人建筑区3\");\r\n      //   e.sender.runCommandAsync(\"gamemode 1\");\r\n      //   e.sender.runCommandAsync(\r\n      //     \"tp \" +\r\n      //       (data.settings.new_player.end_x - data.settings.new_player.begin_x) / 2 +\r\n      //       \" 200 \" +\r\n      //       (data.settings.new_player.end_z - data.settings.new_player.begin_z) / 2\r\n      //   );\r\n      // }\r\n    }\r\n  });\r\n  // 实体清除\r\n  var tick = 20;\r\n  world.events.tick.subscribe((e) => {\r\n    --tick;\r\n    if (tick <= 0) {\r\n      tick = 20;\r\n      let nowTime = new Date().getTime();\r\n      data.settings.entity_clear.config.forEach((config: EntityClearConfigType) => {\r\n        // tellMessage(moduleName, \"nowTime - config.last_clear = \" + (nowTime - config.last_clear));\r\n        if (!config.enable) return;\r\n        if (\r\n          config.forecast &&\r\n          !config.forecasted &&\r\n          nowTime - config.last_clear >= (config.time - config.foretime) * 1000\r\n        ) {\r\n          tellMessage(\r\n            data.settings.entity_clear.sender,\r\n            \"还有§c\" + config.foretime + \"秒§r就要清理§e§l\" + config.show ?? config.name + \"§r了！\"\r\n          );\r\n          config.forecasted = true;\r\n        }\r\n        if (nowTime - config.last_clear >= config.time * 1000) {\r\n          clearEntity(config);\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  return { moduleName, moduleVersion };\r\n}\r\nexport { initServerManage, clearEntity };\r\n"],"sourceRoot":"../../../scripts/"}